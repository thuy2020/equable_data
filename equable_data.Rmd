---
title: "Untitled"
output: html_document
date: "2023-05-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(janitor)
library(stringr)
options(scipen = 9999)
```

# Equable Data

Data scraped from Pension system. Estimate share of total pension system for teacher. 
FL, AZ : teachers pensions are incorporated in states -> applied pct share of liabilities & unfunded liabilities. 
In states that report teachers separately, it's easier. Some others, "impossible". 
```{r}
state <- data_frame(state.abb, state.name) %>% rename(StateName = state.name) %>% 
  add_row(state.abb = "DC", StateName = "District of Columbia")

equable <- readxl::read_xlsx("data/Teacher and Public School Funding Data.xlsx", sheet = "Just Teachers") %>% 
  filter(Year == 2020 | Year == 2021) %>% 
  group_by(StateName, Year) %>% 
  mutate(equable_UAL_bystate = sum(UAL),
         equable_teachUAL = sum(TeachUAL),
         equable_liabilities = sum(Liabilities)) %>% 
  arrange(StateName) %>% 
  select(StateName, equable_UAL_bystate, Year, equable_liabilities) %>%
  rename (year = Year) %>% left_join(state)
```
# Acfrs data
```{r}
acfrs_2020 <- readRDS("data/data_from_dbsite_2020.RDS") %>% 
  filter(category == "School District" ) 
  
acfrs_2021 <- readRDS("data/data_from_dbsite_2021.RDS") %>% 
  filter(category == "School District") 

acfrs <- acfrs_2020 %>% rbind(acfrs_2021) %>% 
  select(state, id, name, net_pension_liability, year) %>% 
group_by(state, year) %>% 
    mutate(acfrs_netpension_liabilities_bystate = sum(net_pension_liability)) %>%
  ungroup() %>% 
  select(-c(name, net_pension_liability, id)) %>% distinct() %>% 
  rename(state.abb = state) %>% arrange(state.abb)

```


# Joining
```{r}
equable_acfrs <- equable %>% left_join(state) %>% 
  left_join(acfrs) %>% 
  filter(acfrs_netpension_liabilities_bystate != 0) %>%  # filter out to calculate percentage
  mutate(pct_equable_acfrs = equable_UAL_bystate/acfrs_netpension_liabilities_bystate,
         diff_equable_acfrs = ((equable_UAL_bystate - acfrs_netpension_liabilities_bystate)/1000000000)) %>%  distinct() %>% select(-state.abb) %>% arrange(desc(diff_equable_acfrs)) %>% 
           select(StateName, equable_UAL_bystate, acfrs_netpension_liabilities_bystate,diff_equable_acfrs, pct_equable_acfrs) 


equable_acfrs %>% filter(StateName == "Nevada")
# state acfrs Texas net pension liabilities: 67,084,585,000	
# not broken out to different types of employee. 
# ERS about 38 bil 
# the left 29 bil -> is liabilities of people who are not state employee --> teachers? (Need to check: state agrees to take this responsibilities somewhere?)
#?: Districts only report their share of liabilities. States counting in their share the liabilities burden with districts.

# verify other states: IL --> due to blended rate? or is that the sharing burden bt state and school districts?
# NV, NJ: checking break down of allocation. 

# What's next?

# Reframe the question: How much pension/ open debt do K-12 districts hold? ( vs. How much teachers' net pension liabilities)
# actual k-12 pension debt vs. state and other employer pension debt
```

# NCES

List of all school districts that has 1 or more student. 
NOTE: Some acfrs entities are categorized as "school districts" without any students. 
```{r}
nces <- rio::import(here::here("data", "ncesdata_DBBFFFC.xlsx"), skip = 14) %>% 
  clean_names() %>% 
  select(nces_district_id, district_name, county_name, city, state, students) %>% 
  rename(nces_original_name = district_name,
    ncesID = nces_district_id) %>% 
    drop_na(nces_original_name) %>% 
# take out 5 territories "AS" "DC" "GU" "PR" "VI"
 # filter(!state %in% c("AS", "DC", "GU", "PR", "VI")) %>% 
  
# for NCES ID that has only 6 digits, adding a leading 0
  mutate(ncesID = ifelse(str_length(ncesID) < 7, paste0("0", ncesID), ncesID)) %>% 
mutate(students = as.numeric(students)) 

nces %>% filter(state == "TX") %>% arrange(desc(students))
```

```{r}
equable %>% filter(StateName == "Texas")
```
```{r}
acfrs_2020 %>% filter(state == "TX") %>% arrange(desc(net_pension_liability)) %>% select(state, name, net_pension_liability) %>% 
  mutate(acfrs_tot_netpension = sum(net_pension_liability))
```



# Connecticut

The biggest gap is Connecticut. 

```{r}
# all CT entities in acfrs 2020 and 2021
acfrs_2020 %>% filter(state == "CT") %>% select(state, name, net_pension_liability) %>% arrange(desc(net_pension_liability))

acfrs_2021 %>% filter(state == "CT")
```

```{r}
# all CT school districts in NCES
nces %>% filter(state == "CT") %>% arrange(desc(students)) %>% 
  select(state, ncesID, nces_original_name, students)
```
# Montana


```{r}
equable_acfrs %>% filter(StateName == "Montana")
```
View MT in acfrs
```{r}
acfrs_2020 %>% filter(state == "MT") %>% select(state, name, net_pension_liability) %>% arrange(desc(net_pension_liability))

acfrs_2021 %>% filter(state == "MT")
```

Full list of MT in NCES

```{r}
nces %>% filter(state == "MT") %>% arrange(desc(students)) %>% 
  select(state, ncesID, nces_original_name, students)
```

# View California 

CA has total of 1018 School districts, 5,852,544 students. ACFRs collected 934 sd. Equatable liabilities is 4.6 times Acfrs net pension liabilities.

```{r}
equable_acfrs %>% filter(StateName == "California") 
```


# View Florida 

Florida has 96 school districts. Acfrs covers 78. Equatable liabilities is 4.5 times Acfrs net pension liabilities. 

```{r}
equable_acfrs %>% filter(StateName == "Florida")
```

```{r}
equable_acfrs %>% filter(StateName == "Texas")
```




